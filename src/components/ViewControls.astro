---
import Search from './Search.astro';

interface Props {
	hideListGrid?: boolean;
}

const { hideListGrid = false } = Astro.props;
---

<div class="flex justify-end items-center">
	<Search />
	{!hideListGrid && (
		<>
			<button 
				title="Column 1 Layout" 
				class="btn btn-sm btn-ghost list-view-btn" 
				data-view="list"
			>
				<i class="fas fa-bars"></i>
			</button>
			<button 
				title="Column 3 Layout" 
				class="btn btn-sm btn-ghost grid-view-btn" 
				data-view="grid"
				style="display: none;"
			>
				<i class="fas fa-th"></i>
			</button>
		</>
	)}
	<button 
		title="Full Screen" 
		class="btn btn-sm btn-ghost fullscreen-btn"
	>
		<i class="fas fa-expand"></i>
	</button>
	<button 
		title="Settings" 
		class="btn btn-sm btn-ghost settings-btn"
	>
		<i class="fas fa-cog"></i>
	</button>
</div>


<script is:inline>
	// Apply view immediately to prevent flash
	(function() {
		const savedView = localStorage.getItem('postView') || 'grid';
		
		// Check if we're on a page that should show list/grid buttons
		const pathname = window.location.pathname;
		const shouldShowButtons = pathname === '/' || 
			pathname.match(/^\/page\//) || 
			pathname.match(/^\/author\//) || 
			pathname.match(/^\/category\//);
		
		// Set button visibility immediately - always show opposite of current view
		function setButtonVisibility() {
			const listBtn = document.querySelector('.list-view-btn');
			const gridBtn = document.querySelector('.grid-view-btn');
			if (listBtn && gridBtn) {
				if (!shouldShowButtons) {
					// Hide buttons on blog post pages
					listBtn.style.display = 'none';
					gridBtn.style.display = 'none';
				} else {
					// Always show the opposite button
					if (savedView === 'list') {
						// List is active, show grid button (hide list button)
						listBtn.style.display = 'none';
						gridBtn.style.display = '';
					} else {
						// Grid is active, show list button (hide grid button)
						gridBtn.style.display = 'none';
						listBtn.style.display = '';
					}
				}
			}
		}
		
		// Find and apply view class immediately to all PostGrid lists
		function applyViewClass() {
			const allUls = document.querySelectorAll('main ul.grid-view, main ul.list-view, section ul.grid-view, section ul.list-view');
			allUls.forEach((ul) => {
				if (savedView === 'list') {
					ul.classList.add('list-view');
					ul.classList.remove('grid-view');
				} else {
					ul.classList.add('grid-view');
					ul.classList.remove('list-view');
				}
			});
			// Set button visibility
			setButtonVisibility();
		}
		
		// Apply view class and set button visibility immediately
		applyViewClass();
		setButtonVisibility();
		
		// Use requestAnimationFrame to run as early as possible
		if (typeof requestAnimationFrame !== 'undefined') {
			requestAnimationFrame(() => {
				applyViewClass();
				setButtonVisibility();
			});
		}
		
		// Apply when DOM is ready
		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', () => {
				applyViewClass();
				setButtonVisibility();
			});
		} else {
			// DOM already ready, apply immediately
			applyViewClass();
			setButtonVisibility();
		}
		
		// Also set button visibility after short delays to catch any late-rendered buttons
		setTimeout(() => {
			applyViewClass();
			setButtonVisibility();
		}, 0);
		setTimeout(() => {
			applyViewClass();
			setButtonVisibility();
		}, 10);
		setTimeout(() => {
			applyViewClass();
			setButtonVisibility();
		}, 50);
		setTimeout(() => {
			applyViewClass();
			setButtonVisibility();
		}, 100);
	})();
</script>

<script>
	// Wait for DOM to be ready
	function initViewControls() {
		// Find all posts lists - look for all ul in main/section that have grid-view or list-view class
		function findAllPostsLists(): NodeListOf<HTMLElement> {
			const main = document.querySelector('main');
			if (main) {
				const uls = main.querySelectorAll('ul.grid-view, ul.list-view') as NodeListOf<HTMLElement>;
				if (uls.length > 0) return uls;
			}
			
			// Fallback: find any ul in main/section that's not pagination or menu
			const allUls = document.querySelectorAll('main ul, section ul') as NodeListOf<HTMLElement>;
			const filtered: HTMLElement[] = [];
			allUls.forEach((ul) => {
				if (!ul.closest('.pagination') && !ul.classList.contains('menu')) {
					filtered.push(ul);
				}
			});
			return filtered as unknown as NodeListOf<HTMLElement>;
		}
		
		// Initialize view from localStorage or default to grid
		const savedView = localStorage.getItem('postView') || 'grid';
		const postsLists = findAllPostsLists();
		
		function applyView(view: string) {
			postsLists.forEach((postsList) => {
				if (view === 'list') {
					postsList.classList.add('list-view');
					postsList.classList.remove('grid-view');
				} else {
					postsList.classList.add('grid-view');
					postsList.classList.remove('list-view');
				}
			});
		}
		
		// Check if we're on a page that should show list/grid buttons
		// Show buttons on: homepage (/), pagination (/page/*), author pages (/author/*), category pages (/category/*)
		// Hide buttons on: blog post pages (everything else)
		const pathname = window.location.pathname;
		const shouldShowButtons = pathname === '/' || 
			pathname.match(/^\/page\//) || 
			pathname.match(/^\/author\//) || 
			pathname.match(/^\/category\//);
		
		// Update button visibility - always show opposite of active view
		const listBtnEl = document.querySelector('.list-view-btn') as HTMLElement | null;
		const gridBtnEl = document.querySelector('.grid-view-btn') as HTMLElement | null;
		
		if (!shouldShowButtons) {
			// Hide buttons on blog post pages and other pages
			if (listBtnEl) listBtnEl.style.display = 'none';
			if (gridBtnEl) gridBtnEl.style.display = 'none';
		} else if (postsLists.length > 0) {
			// Apply saved view
			applyView(savedView);
			
			// Always show the opposite button
			if (listBtnEl && gridBtnEl) {
				if (savedView === 'list') {
					// List is active, show grid button (hide list button)
					listBtnEl.style.display = 'none';
					gridBtnEl.style.display = '';
				} else {
					// Grid is active, show list button (hide grid button)
					gridBtnEl.style.display = 'none';
					listBtnEl.style.display = '';
				}
			}
		} else {
			// Should show buttons but no posts list found, hide them
			if (listBtnEl) listBtnEl.style.display = 'none';
			if (gridBtnEl) gridBtnEl.style.display = 'none';
		}
		
		// List/Grid toggle
		const listBtn = document.querySelector('.list-view-btn') as HTMLElement | null;
		const gridBtn = document.querySelector('.grid-view-btn') as HTMLElement | null;
		
		if (listBtn) {
			listBtn.addEventListener('click', (e) => {
				e.preventDefault();
				const postsLists = findAllPostsLists();
				const listBtnEl = document.querySelector('.list-view-btn') as HTMLElement | null;
				const gridBtnEl = document.querySelector('.grid-view-btn') as HTMLElement | null;
				
				if (postsLists.length > 0) {
					postsLists.forEach((postsList) => {
						postsList.classList.add('list-view');
						postsList.classList.remove('grid-view');
					});
					localStorage.setItem('postView', 'list');
					
					// Hide list button, show grid button (opposite)
					if (listBtnEl) {
						listBtnEl.style.display = 'none';
					}
					if (gridBtnEl) {
						gridBtnEl.style.display = '';
					}
				}
			});
		}
		
		if (gridBtn) {
			gridBtn.addEventListener('click', (e) => {
				e.preventDefault();
				const postsLists = findAllPostsLists();
				const listBtnEl = document.querySelector('.list-view-btn') as HTMLElement | null;
				const gridBtnEl = document.querySelector('.grid-view-btn') as HTMLElement | null;
				
				if (postsLists.length > 0) {
					postsLists.forEach((postsList) => {
						postsList.classList.add('grid-view');
						postsList.classList.remove('list-view');
					});
					localStorage.setItem('postView', 'grid');
					
					// Hide grid button, show list button (opposite)
					if (gridBtnEl) {
						gridBtnEl.style.display = 'none';
					}
					if (listBtnEl) {
						listBtnEl.style.display = '';
					}
				}
			});
		}
	}
	
	// Run when DOM is ready - use setTimeout to ensure everything is loaded
	setTimeout(() => {
		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', initViewControls);
		} else {
			initViewControls();
		}
	}, 100);
	
	// Fullscreen toggle
	document.querySelector('.fullscreen-btn')?.addEventListener('click', () => {
		if (!document.fullscreenElement) {
			document.documentElement.requestFullscreen().catch(err => {
				console.error('Error attempting to enable fullscreen:', err);
			});
		} else {
			document.exitFullscreen();
		}
	});
	
	// Update fullscreen icon based on state
	document.addEventListener('fullscreenchange', () => {
		const fullscreenBtn = document.querySelector('.fullscreen-btn i');
		if (fullscreenBtn) {
			if (document.fullscreenElement) {
				fullscreenBtn.classList.remove('fa-expand');
				fullscreenBtn.classList.add('fa-compress');
			} else {
				fullscreenBtn.classList.remove('fa-compress');
				fullscreenBtn.classList.add('fa-expand');
			}
		}
	});
	
	// Settings button - open modal
	document.querySelector('.settings-btn')?.addEventListener('click', () => {
		const modal = document.getElementById('settings-modal') as HTMLDialogElement;
		if (modal) {
			modal.showModal();
			// Trigger custom event to populate modal content
			window.dispatchEvent(new CustomEvent('settingsModalOpen'));
		}
	});
</script>

