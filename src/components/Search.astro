---
import '@pagefind/default-ui/css/ui.css';
---

<site-search id="search">
    <button
        data-open-modal
        disabled
        class="btn btn-sm btn-ghost"
        title="Search"
    >
        <i class="fas fa-search"></i>
        <span class="sr-only">Search</span>
    </button>
    <dialog
        aria-label="search"
        class="modal backdrop:bg-base-content/50 search-modal"
    >
        <div class="modal-box max-w-3xl search-modal-box relative">
            <button
                data-close-modal
                class="btn btn-sm btn-circle btn-ghost absolute top-2 right-2 z-10"
            >
                <i class="fas fa-times"></i>
            </button>
        <div class="flex flex-col gap-4">
            {
                import.meta.env.DEV ? (
                    <div class="mx-auto text-center">
                        <p>
                            Search is only available in production builds.{' '}
                            <br />
                            Try building and previewing the site to test it out
                            locally.
                        </p>
                    </div>
                ) : (
                    <div class="search-container">
                        <div id="blog__search" />
                    </div>
                )
            }
        </div>
    </dialog>
</site-search>

<script>
    class SiteSearch extends HTMLElement {
        constructor() {
            super();
            const openBtn = this.querySelector<HTMLButtonElement>(
                'button[data-open-modal]'
            )!;
            const closeBtn = this.querySelector<HTMLButtonElement>(
                'button[data-close-modal]'
            )!;
            const dialog = this.querySelector('dialog')!;
            const dialogFrame = this.querySelector('.modal-box')!;

            const onWindowClick = (event: MouseEvent) => {
                // check if it's a link
                const isLink = 'href' in (event.target || {});
                // make sure the click is either a link or outside of the dialog
                const target = event.target as Node;
                if (
                    isLink ||
                    (document.body.contains(target) &&
                        !dialogFrame.contains(target))
                )
                    closeModal();
            };

            const openModal = (event?: MouseEvent) => {
                dialog.showModal();
                this.querySelector('input')?.focus();
                event?.stopPropagation();
                window.addEventListener('click', onWindowClick);
            };

            const closeModal = () => {
                if (dialog.open) {
                    dialog.close();
                    window.removeEventListener('click', onWindowClick);
                }
            };

            openBtn.addEventListener('click', openModal);
            openBtn.disabled = false;
            closeBtn.addEventListener('click', closeModal);

            // Listen for `/` keyboard shortcut
            window.addEventListener('keydown', (e) => {
                if (e.key === '/' && !dialog.open) {
                    openModal();
                    e.preventDefault();
                }
            });

            function createUI() {
                if (import.meta.env.DEV) return;

                const onIdle =
                    window.requestIdleCallback || ((cb) => setTimeout(cb, 1));

                onIdle(async () => {
                    const { PagefindUI } = await import('@pagefind/default-ui');
                    new PagefindUI({
                        element: '#blog__search',
                        baseUrl: import.meta.env.BASE_URL,
                        bundlePath:
                            import.meta.env.BASE_URL.replace(/\/$/, '') +
                            '/pagefind/',
                        showImages: false,
                        showSubResults: true,
                    });
                });
            }

            if (document.readyState !== 'loading') {
                createUI();
            } else {
                window.addEventListener('DOMContentLoaded', () => {
                    createUI();
                });
            }

            // close modal and clear input on view-transtion
            document.addEventListener('astro:after-swap', () => {
                // clear the search field
                (
                    document.querySelector(
                        '.pagefind-ui__search-clear'
                    ) as HTMLButtonElement
                )?.click();
                // close the modal & remove event listener on body
                closeModal();
            });
        }
    }

    customElements.define('site-search', SiteSearch);
</script>

<style is:global>
    #blog__search .pagefind-ui__search-input {
        outline: none;
    }

    #blog__search .pagefind-ui__search-clear {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        background: hsl(var(--b1));
        height: auto;
        top: 8px;
        right: 12px;
        border-radius: var(--rounded-btn, 0.5rem);
    }

    #blog__search .pagefind-ui__result {
        color: hsl(var(--bc));
        margin-bottom: 0.5rem !important;
        padding-top: 0.5rem !important;
        padding-bottom: 0.5rem !important;
    }

    #blog__search .pagefind-ui__result-inner {
        padding-top: 0 !important;
        padding-bottom: 0 !important;
    }

    #blog__search li.pagefind-ui__result {
        padding-top: 0.5rem !important;
        padding-bottom: 0.5rem !important;
    }

    #blog__search li.pagefind-ui__result .pagefind-ui__result-inner {
        padding-top: 0 !important;
        padding-bottom: 0 !important;
    }

    #blog__search .pagefind-ui__result-link {
        color: hsl(var(--p));
    }

    #blog__search {
        --pagefind-ui-text: hsl(var(--bc));
        --pagefind-ui-background: hsl(var(--b1));
        --pagefind-ui-primary: hsl(var(--p));
        --pagefind-ui-border: hsl(var(--bc) / 0.2);
        --pagefind-ui-border-width: 1px;
    }

    #blog__search .pagefind-ui__results-area {
        gap: 0.5rem !important;
    }

    #blog__search .pagefind-ui__results-list {
        gap: 0.5rem !important;
    }

    /* Reduce padding in modal box */
    site-search .search-modal-box {
        padding: 1rem !important;
    }

    /* Position search modal at top on mobile */
    @media (max-width: 768px) {
        site-search dialog.search-modal {
            align-items: flex-start !important;
            padding-top: 10vh;
            justify-content: center;
        }

        site-search dialog.search-modal .search-modal-box {
            margin-top: 0 !important;
            margin-bottom: auto !important;
            max-height: calc(90vh - 10vh);
            overflow-y: auto;
            width: calc(100% - 2rem);
            max-width: calc(100% - 2rem);
            padding: 0.75rem !important;
        }
    }

    /* Reduce padding in search container */
    site-search .search-container {
        padding: 0;
        margin: 0;
    }

    /* Adjust search input positioning */
    #blog__search .pagefind-ui__search-input-wrapper {
        margin-bottom: 0.5rem;
    }
</style>