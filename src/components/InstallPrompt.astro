---
// Custom "Install app" / Add to Home Screen prompt.
// The browser's native install prompt only appears when it decides to (e.g. engagement).
// This component listens for beforeinstallprompt and shows our own install button.
---
<div id="install-prompt" class="install-prompt card bg-primary text-primary-content shadow-xl rounded-box border border-primary-content/10 p-4 flex flex-col gap-3" role="region" aria-label="Install app" hidden>
	<p class="install-prompt__message m-0 text-sm font-medium">Install Narikothon for a better experience</p>
	<div class="install-prompt__actions flex gap-2 justify-end">
		<button type="button" id="install-prompt-accept" class="btn btn-primary btn-sm bg-primary-content text-primary border-primary-content">Install</button>
		<button type="button" id="install-prompt-dismiss" class="btn btn-ghost btn-sm text-primary-content/90 hover:bg-primary-content/20">Not now</button>
	</div>
</div>

<script>
	interface InstallPromptEvent extends Event {
		prompt(): void;
		userChoice: Promise<{ outcome: string }>;
	}

	(function () {
		let deferredPrompt: InstallPromptEvent | null = null;
		const banner = document.getElementById('install-prompt');
		const acceptBtn = document.getElementById('install-prompt-accept');
		const dismissBtn = document.getElementById('install-prompt-dismiss');
		const STORAGE_KEY = 'pwa-install-dismissed';

		function showBanner() {
			if (banner && !sessionStorage.getItem(STORAGE_KEY)) {
				banner.hidden = false;
			}
		}

		function hideBanner() {
			if (banner) {
				banner.hidden = true;
			}
		}

		window.addEventListener('beforeinstallprompt', (e) => {
			e.preventDefault();
			deferredPrompt = e as InstallPromptEvent;
			showBanner();
		});

		acceptBtn?.addEventListener('click', async () => {
			if (!deferredPrompt) return;
			deferredPrompt.prompt();
			const { outcome } = await deferredPrompt.userChoice;
			if (outcome === 'accepted') {
				hideBanner();
			}
			deferredPrompt = null;
		});

		dismissBtn?.addEventListener('click', () => {
			sessionStorage.setItem(STORAGE_KEY, 'true');
			hideBanner();
		});

		// Hide if already installed (standalone / display-mode standalone)
		const nav = window.navigator as Window['navigator'] & { standalone?: boolean };
		if (window.matchMedia('(display-mode: standalone)').matches || nav.standalone) {
			hideBanner();
		}
	})();
</script>

<style>
	.install-prompt {
		position: fixed;
		bottom: 1rem;
		left: 1rem;
		right: 1rem;
		max-width: 24rem;
		margin: 0 auto;
		z-index: 9999;
	}
	.install-prompt[hidden] {
		display: none !important;
	}
</style>
