---
import { Image } from 'astro:assets';
import FormattedDate from './FormattedDate.astro';

interface Props {
	post: {
		id: string;
		data: {
			title?: string;
			coverImage?: any;
			heroImage?: any;
			author?: string;
			pubDate?: Date;
			description?: string;
			body?: string;
		};
	};
	content?: string; // Optional raw content for reading time calculation
	title?: boolean;
	thumbnail?: boolean;
	author?: boolean;
	excerpt?: boolean;
	date?: boolean;
	readingTime?: boolean;
}

const {
	post,
	content,
	title = true,
	thumbnail = true,
	author = true,
	excerpt = true,
	date = true,
	readingTime = true,
} = Astro.props;

// Calculate reading time (average 200  words per minute)
function calculateReadingTime(content: string | undefined): number {
	if (!content) return 1;
	const words = content.trim().split(/\s+/).length;
	return Math.max(1, Math.ceil(words / 200));
}

// Get excerpt from description or use a default
const excerptText = post.data.description || '';

// Use provided content for reading time, fallback to description
const readingTimeContent = content || excerptText;
const readingTimeMinutes = calculateReadingTime(readingTimeContent);

const displayImage = post.data.coverImage || post.data.heroImage;
const postUrl = `/${post.id}/`;
---

<style is:global>
	/* View switching */
	.grid-view-card {
		display: block;
	}
	.list-view-card {
		display: none;
	}
	ul.list-view .grid-view-card {
		display: none !important;
	}
	ul.list-view .list-view-card {
		display: flex !important;
	}
	ul.list-view li {
		width: 100%;
	}
	ul.list-view .list-view-card {
		min-height: auto;
	}
	ul.grid-view li {
		width: calc(33.333% - 1.334rem);
	}
	@media (min-width: 721px) and (max-width: 1024px) {
		ul.grid-view li {
			width: calc(50% - 1rem);
		}
	}
	@media (max-width: 720px) {
		ul.grid-view li {
			width: 100%;
		}
		ul {
			gap: 0.5rem;
		}
		.list-view-card .w-\[120px\] {
			width: 120px !important;
		}
		.list-view-card .w-\[120px\] img {
			height: 68px !important;
		}
	}
</style>

<!-- Grid View: DaisyUI Card -->
<div class="grid-view-card block">
	<div class="card bg-base-100 shadow-sm border border-base-content/20 h-full flex flex-col relative">
		<a href={postUrl} class="absolute inset-0 z-0" aria-label={`Read ${post.data.title || 'post'}`}></a>
		{thumbnail && displayImage && (
			<figure class="aspect-video overflow-hidden flex-shrink-0 m-0 p-0 rounded-t-box relative z-0">
				<Image width={800} height={450} src={displayImage} alt={post.data.title || ''} class="w-full h-full object-cover object-center rounded-t-box" />
			</figure>
		)}
		{!thumbnail && displayImage && (
			<figure class="h-56 bg-base-200 flex-shrink-0 m-0 rounded-t-box"></figure>
		)}
		<div class="card-body flex-1 flex flex-col gap-0 p-3 pb-2 pt-2 relative z-0">
			{title && post.data.title && (
				<h2 class="card-title line-clamp-1 text-base mb-6 leading-snug">
					{post.data.title}
				</h2>
			)}
			{author && post.data.author && (
				<div class="mb-1 -mt-5 relative z-10" data-author-wrapper>
					<a 
						href={`/author/${post.data.author}/`} 
						class="link text-sm flex items-center gap-1 pointer-events-auto relative z-10 author-link"
						data-author-url={`/author/${post.data.author}/`}
					>
						<i class="fas fa-feather-alt text-xs"></i>
						{post.data.author}
					</a>
				</div>
			)}
			{!author && <div class="h-3 mb-1"></div>}
			{excerpt && excerptText && (
				<p class="text-sm text-base-content/70 line-clamp-3 flex-1 mb-0">{excerptText}</p>
			)}
			{!excerpt && <div class="flex-1"></div>}
			<div class="card-actions justify-start text-xs text-base-content/60 mt-0 pt-0 pb-0 flex items-center gap-2">
				{date && post.data.pubDate && (
					<span class="flex items-center gap-1">
						<i class="far fa-calendar-alt text-xs"></i>
						<FormattedDate date={post.data.pubDate} />
					</span>
				)}
				{readingTime && (
					<span class="flex items-center gap-1">
						<i class="far fa-clock text-xs"></i>
						{readingTimeMinutes} min read
					</span>
				)}
			</div>
		</div>
	</div>
</div>

<!-- List View: Simple layout with thumbnail on left -->
<div class="list-view-card hidden flex flex-row gap-2 items-start card bg-base-100 shadow-sm border border-base-content/20 p-2 w-full relative">
	<a href={postUrl} class="absolute inset-0 z-0" aria-label={`Read ${post.data.title || 'post'}`}></a>
	{thumbnail && displayImage && (
		<div class="w-[120px] md:w-1/3 flex-shrink-0 relative z-0">
			<Image width={600} height={400} src={displayImage} alt={post.data.title || ''} class="w-full h-[68px] md:h-40 object-cover rounded-box" />
		</div>
	)}
	<div class="flex-1 relative z-0">
		{title && post.data.title && (
			<h3 class="text-xl md:text-2xl font-semibold mb-1 md:mb-2 hover:text-primary">
				{post.data.title}
			</h3>
		)}
		{author && post.data.author && (
			<div class="mb-1 md:mb-2 relative z-10" data-author-wrapper>
				<a 
					href={`/author/${post.data.author}/`} 
					class="link text-sm flex items-center gap-1 pointer-events-auto relative z-10 author-link"
					data-author-url={`/author/${post.data.author}/`}
				>
					<i class="fas fa-feather-alt text-xs"></i>
					{post.data.author}
				</a>
			</div>
		)}
		{excerpt && excerptText && (
			<p class="text-sm text-base-content/70 mb-1 line-clamp-2">{excerptText}</p>
		)}
		<div class="flex items-center gap-2 text-xs text-base-content/60 mt-0 mb-0">
			{date && post.data.pubDate && (
				<span class="flex items-center gap-1">
					<i class="far fa-calendar-alt text-xs"></i>
					<FormattedDate date={post.data.pubDate} />
				</span>
			)}
			{readingTime && (
				<span class="flex items-center gap-1">
					<i class="far fa-clock text-xs"></i>
					{readingTimeMinutes} min read
				</span>
			)}
		</div>
	</div>
</div>

<script>
	// Handle author link clicks - prevent card link from firing
	(function() {
		document.addEventListener('click', function(e) {
			const authorLink = (e.target as HTMLElement).closest('.author-link');
			if (authorLink) {
				e.stopPropagation();
				e.preventDefault();
				const url = (authorLink as HTMLElement).getAttribute('data-author-url') || authorLink.getAttribute('href');
				if (url) {
					window.location.href = url;
				}
			}
		}, true);
	})();
</script>
