---
import { Image } from 'astro:assets';
import FormattedDate from './FormattedDate.astro';

interface Props {
	post: {
		id: string;
		data: {
			title?: string;
			coverImage?: any;
			heroImage?: any;
			author?: string;
			pubDate?: Date;
			description?: string;
			body?: string;
		};
	};
	content?: string; // Optional raw content for reading time calculation
	title?: boolean;
	thumbnail?: boolean;
	author?: boolean;
	excerpt?: boolean;
	date?: boolean;
	readingTime?: boolean;
}

const {
	post,
	content,
	title = true,
	thumbnail = true,
	author = true,
	excerpt = true,
	date = true,
	readingTime = true,
} = Astro.props;

// Calculate reading time (average 200 words per minute)
function calculateReadingTime(content: string | undefined): number {
	if (!content) return 1;
	const words = content.trim().split(/\s+/).length;
	return Math.max(1, Math.ceil(words / 200));
}

// Get excerpt from description or use a default
const excerptText = post.data.description || '';

// Use provided content for reading time, fallback to description
const readingTimeContent = content || excerptText;
const readingTimeMinutes = calculateReadingTime(readingTimeContent);

const displayImage = post.data.coverImage || post.data.heroImage;
const postUrl = `/${post.id}/`;
---

<!-- Grid View: DaisyUI Card -->
<div class="grid-view-card block">
	<div class="card bg-base-100 shadow-sm h-full flex flex-col min-h-[500px]">
		{thumbnail && displayImage && (
			<figure class="h-56 overflow-hidden flex-shrink-0">
				<a href={postUrl}>
					<Image width={400} height={225} src={displayImage} alt={post.data.title || ''} class="w-full h-full object-cover" />
				</a>
			</figure>
		)}
		{!thumbnail && displayImage && (
			<figure class="h-56 bg-base-200 flex-shrink-0"></figure>
		)}
		<div class="card-body flex-1 flex flex-col">
			{title && post.data.title && (
				<h2 class="card-title line-clamp-3 text-xs min-h-[3rem]">
					<a href={postUrl} class="no-underline">{post.data.title}</a>
				</h2>
			)}
			{!title && <div class="h-12"></div>}
			{author && post.data.author && (
				<div>
					<a 
						href={`/author/${post.data.author}/`} 
						class="link link-primary text-sm"
						onclick={(e: Event) => e.stopPropagation()}
					>
						{post.data.author}
					</a>
				</div>
			)}
			{!author && <div class="h-6"></div>}
			{excerpt && excerptText && (
				<p class="text-sm text-base-content/70 line-clamp-3 flex-1">{excerptText}</p>
			)}
			{!excerpt && <div class="flex-1"></div>}
			<div class="card-actions justify-start text-xs text-base-content/60 mt-auto">
				{date && post.data.pubDate && (
					<span>
						<FormattedDate date={post.data.pubDate} />
					</span>
				)}
				{readingTime && (
					<span>• {readingTimeMinutes} min read</span>
				)}
			</div>
		</div>
	</div>
</div>

<!-- List View: Simple layout with thumbnail on left -->
<div class="list-view-card hidden flex flex-row gap-4 items-stretch card bg-base-100 shadow-sm p-4 w-full">
	{thumbnail && displayImage && (
		<div class="w-1/3 flex-shrink-0">
			<a href={postUrl}>
				<Image width={300} height={200} src={displayImage} alt={post.data.title || ''} class="w-full h-40 object-cover rounded-box" />
			</a>
		</div>
	)}
	<div class="flex-1">
		{title && post.data.title && (
			<h3 class="text-2xl font-semibold mb-2">
				<a href={postUrl} class="no-underline hover:text-primary">{post.data.title}</a>
			</h3>
		)}
		{author && post.data.author && (
			<div class="mb-2">
				<a 
					href={`/author/${post.data.author}/`} 
					class="link link-primary text-sm"
					onclick={(e: Event) => e.stopPropagation()}
				>
					{post.data.author}
				</a>
			</div>
		)}
		{excerpt && excerptText && (
			<p class="text-sm text-base-content/70 mb-2 line-clamp-2">{excerptText}</p>
		)}
		<div class="flex items-center gap-2 text-xs text-base-content/60">
			{date && post.data.pubDate && (
				<span>
					<FormattedDate date={post.data.pubDate} />
				</span>
			)}
			{readingTime && (
				<span>• {readingTimeMinutes} min read</span>
			)}
		</div>
	</div>
</div>

<style is:global>
	/* View switching - using Tailwind classes */
	ul.list-view .grid-view-card {
		display: none !important;
	}
	ul.list-view .list-view-card {
		display: flex !important;
	}
	/* Ensure list view items have equal width */
	ul.list-view li {
		width: 100%;
	}
	ul.list-view .list-view-card {
		width: 100%;
		min-height: 200px;
	}
	/* Grid view responsive widths */
	ul.grid-view li {
		width: calc(33.333% - 1.334rem);
	}
	@media (min-width: 721px) and (max-width: 1024px) {
		ul.grid-view li {
			width: calc(50% - 1rem);
		}
	}
	@media (max-width: 720px) {
		ul.grid-view li {
			width: 100%;
		}
		ul {
			gap: 0.5rem;
		}
		.list-view-card h3 {
			font-size: 1.25rem !important;
		}
		main {
			padding: 1em 0.5em;
		}
		img {
			display: block;
			margin-left: auto;
			margin-right: auto;
		}
		p {
			text-align: justify;
		}
	}
</style>
