---
import { Image } from 'astro:assets';
import type { CollectionEntry } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';
import Header from '../components/Header.astro';
import SettingsModal from '../components/SettingsModal.astro';

type Props = CollectionEntry<'blog'>['data'] & {
	body?: string;
	rawContent?: string;
};

const { title, description, pubDate, updatedDate, heroImage, coverImage, author, categories, body, rawContent } = Astro.props;
const displayImage = coverImage || heroImage;

// Calculate reading time (average 200 words per minute)
function calculateReadingTime(content: string | undefined): number {
	if (!content) return 1;
	// Remove HTML tags for word count
	const text = content.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
	const words = text.split(/\s+/).filter(word => word.length > 0).length;
	return Math.max(1, Math.ceil(words / 200));
}

// Use rawContent if available, otherwise use body
const contentForReadingTime = rawContent || body || '';
const readingTime = calculateReadingTime(contentForReadingTime);
---

<html lang="en">
	<head>
		<BaseHead title={title} description={description || ''} />
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" />
	</head>

	<body>
		<Header />
		<main class="w-[960px] max-w-[calc(100%-30px)] mx-auto py-12 px-[15px] md:px-4">
			<article class="bg-base-100 p-2 md:p-4 border border-base-content/20 rounded-box">
				<div class="w-full mb-2">
					{displayImage && (
						<Image width={1020} height={510} src={displayImage} alt="" class="block mx-auto rounded-xl shadow-lg" />
					)}
				</div>
				<div class="w-full max-w-full m-0 p-0">
					<div class="mb-4 mt-3">
						<h2 class="m-0 py-2 px-3 text-2xl text-center">{title}</h2>
						<ul class="list-none p-0 my-2 flex flex-wrap justify-center items-center gap-3">
							{author && (
								<li class="flex items-center gap-2">
									<a href={`/author/${author}`} class="no-underline hover:underline" title={`Author - ${author}`}>
										<i class="fas fa-feather-alt mr-1"></i>
										{author}
									</a>
								</li>
							)}
							{categories && categories.length > 0 && (
								<>
									{categories.map((category) => (
										<li class="flex items-center gap-2">
											<a href={`/category/${encodeURIComponent(category)}`} class="no-underline hover:underline pl-2" title={`Category - ${category}`}>
												<i class="fa-solid fa-hashtag mr-1"></i>
												{category}
											</a>
										</li>
									))}
								</>
							)}
						</ul>
						<ul class="list-none p-0 my-2 flex flex-wrap justify-center items-center gap-3">
							{pubDate && (
								<li class="flex items-center gap-2">
									<i class="far fa-calendar-alt mr-1"></i>
									<FormattedDate date={pubDate} />
								</li>
							)}
							<li class="flex items-center gap-2">
								<i class="far fa-clock mr-1"></i>
								{readingTime} MIN READ
							</li>
						</ul>
					</div>
					<slot />
				</div>
			</article>
		</main>
		<Footer />
		<SettingsModal />
	</body>
</html>
