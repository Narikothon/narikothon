---
import { Image } from 'astro:assets';
import type { CollectionEntry } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';
import Header from '../components/Header.astro';
import SettingsModal from '../components/SettingsModal.astro';
import { authorSlug, categorySlug } from '../lib/slug';

type Props = CollectionEntry<'blog'>['data'] & {
	body?: string;
	rawContent?: string;
	postId?: string;
	prevPost?: { id: string; title: string } | null;
	nextPost?: { id: string; title: string } | null;
	currentUrl?: string;
};

const { title, description, pubDate, updatedDate, heroImage, coverImage, author, categories, body, rawContent, postId, prevPost, nextPost, currentUrl } = Astro.props;
const displayImage = coverImage || heroImage;
// Ensure currentUrl is set for sharing
const shareUrl = currentUrl || Astro.url.href;

// Calculate reading time (average 200 words per minute)
function calculateReadingTime(content: string | undefined): number {
	if (!content) return 1;
	// Remove HTML tags for word count
	const text = content.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
	const words = text.split(/\s+/).filter(word => word.length > 0).length;
	return Math.max(1, Math.ceil(words / 200));
}

// Use rawContent if available, otherwise use body
const contentForReadingTime = rawContent || body || '';
const readingTime = calculateReadingTime(contentForReadingTime);
---

<html lang="en">
	<head>
		<BaseHead title={title} description={description || ''} image={displayImage} />
	</head>

	<body>
		<Header />
		<main class="max-w-[48rem] mx-auto py-6 md:py-12 px-4">
			<article class="bg-base-100 border-2 border-base-content/30 rounded-box shadow-lg" data-pagefind-body>
				<div class="w-full mb-2">
					{displayImage && (
						<Image width={1020} height={510} src={displayImage} alt="" class="block mx-auto rounded-t-xl shadow-lg" />
					)}
				</div>
				<div class="w-full max-w-full m-0 p-0">
					<div class="mb-3 md:mb-4 mt-2 md:mt-3 px-4">
						<h2 class="m-0 py-1 md:py-2 px-2 md:px-3 text-xl md:text-2xl font-bold text-center">{title}</h2>
						<ul class="list-none p-0 my-1 md:my-2 flex flex-wrap justify-center items-center gap-2 md:gap-3">
							{author && (
								<li class="flex items-center gap-2">
									<a href={`/author/${authorSlug(author)}/`} class="badge badge-outline hover:badge-primary transition-colors cursor-pointer" title={`Author - ${author}`}>
										<i class="fas fa-feather-alt mr-1"></i>
										{author}
									</a>
								</li>
							)}
							{categories && categories.length > 0 && (
								<>
									{categories.map((category) => (
										<li class="flex items-center gap-2">
											<a href={`/category/${categorySlug(category)}/`} class="badge badge-outline hover:badge-primary transition-colors cursor-pointer" title={`Category - ${category}`}>
												<i class="fa-regular fa-folder mr-1"></i>
												{category}
											</a>
										</li>
									))}
								</>
							)}
						</ul>
						<ul class="list-none p-0 my-1 md:my-2 flex flex-wrap justify-center items-center gap-2 md:gap-3">
							{pubDate && (
								<li class="flex items-center gap-2">
									<i class="far fa-calendar-alt mr-1"></i>
									<FormattedDate date={pubDate} />
								</li>
							)}
							<li class="flex items-center gap-2">
								<i class="far fa-clock mr-1"></i>
								{readingTime} MIN READ
							</li>
						</ul>
					</div>
					<div class="max-w-[40rem] mx-auto px-4 md:px-[4rem] post-content text-justify">
						<style>
							:global(article p) {
								margin-bottom: 1rem;
								text-align: justify;
							}
							:global(article p:last-child) {
								margin-bottom: 0;
							}
							:global(article br) {
								display: block;
								margin-bottom: 0.5rem;
								content: "";
							}
							:global(article h1),
							:global(article h2),
							:global(article h3),
							:global(article h4),
							:global(article h5),
							:global(article h6) {
								margin-top: 1.5rem;
								margin-bottom: 1rem;
							}
							:global(article h1:first-child),
							:global(article h2:first-child),
							:global(article h3:first-child),
							:global(article h4:first-child),
							:global(article h5:first-child),
							:global(article h6:first-child) {
								margin-top: 0;
							}
							:global(article ul),
							:global(article ol) {
								margin-top: 1rem;
								margin-bottom: 1rem;
							}
							:global(article li) {
								margin-bottom: 0.5rem;
							}
							:global(article blockquote) {
								margin-top: 1rem;
								margin-bottom: 1rem;
							}
							/* Drop cap for first paragraph */
							:global(article p:first-of-type::first-letter) {
								float: left;
								font-size: 4.5rem;
								line-height: 0.8;
								padding-right: 0.5rem;
								padding-top: 0.1rem;
								font-weight: bold;
								font-family: serif;
							}
							@media (max-width: 768px) {
								:global(article p:first-of-type::first-letter) {
									font-size: 3.5rem;
								}
							}
							/* Disable drop cap for next/prev post titles */
							:global(#next-prev-box p::first-letter) {
								float: none;
								font-size: inherit;
								line-height: inherit;
								padding: 0;
								font-weight: inherit;
								font-family: inherit;
							}
						</style>
						<slot />
					</div>
					
					<!-- Post Details Section -->
					<div id="post-details" class="mt-8 max-w-[40rem] mx-auto px-4 md:px-[4rem]">
						<!-- Author Box -->
						{author && (
							<div id="author-box" class="bg-base-200 rounded-box p-6 mb-4">
								<div class="text-center">
									<h6 class="text-sm font-semibold mb-2">
										<i class="fas fa-feather-alt mr-2"></i>
										BY
									</h6>
									<h4 class="text-xl font-bold mb-3">
										<a href={`/author/${authorSlug(author)}/`} class="hover:underline">
											{author}
										</a>
									</h4>
									{pubDate && (
										<h6 class="text-sm">
											<i class="far fa-calendar-alt mr-2"></i>
											<FormattedDate date={pubDate} />
										</h6>
									)}
								</div>
							</div>
						)}
						
						<!-- Next/Previous Posts -->
						{(prevPost || nextPost) && (
							<div id="next-prev-box" class="bg-base-200 rounded-box p-4 mb-4">
								<div class={`flex flex-col md:flex-row gap-4 ${!prevPost && nextPost ? 'md:justify-end' : ''}`}>
									{prevPost && (
										<div class={`flex-1 ${nextPost ? 'md:border-r md:border-base-content/20 md:pr-4' : ''}`}>
											<a href={`/${prevPost.id}`} id="prev-post" class="block hover:opacity-80 transition-opacity">
												<div class="text-left p-2">
													<span class="block text-xs font-semibold mb-2 pt-2 opacity-70">PREVIOUS POST</span>
													<p class="text-sm m-0 font-bold">{prevPost.title}</p>
												</div>
											</a>
										</div>
									)}
									{nextPost && (
										<div class={`${prevPost ? 'flex-1 md:pl-4' : 'md:ml-auto'}`}>
											<a href={`/${nextPost.id}`} id="next-post" class="block hover:opacity-80 transition-opacity">
												<div class={`p-2 ${prevPost ? 'text-right' : 'text-right'}`}>
													<span class="block text-xs font-semibold mb-2 pt-2 opacity-70">NEXT POST</span>
													<p class="text-sm m-0 font-bold">{nextPost.title}</p>
												</div>
											</a>
										</div>
									)}
								</div>
							</div>
						)}
						
						<!-- Share Box -->
						<div id="share-box" class="bg-base-200 rounded-box p-6 text-center">
							<h4 class="text-xl font-bold mb-4">Share</h4>
							<div class="max-w-md mx-auto mb-4">
								<div class="input-group">
									<span class="input-group-text">
										<i class="fas fa-link"></i>
									</span>
									<input 
										type="text" 
										class="input input-bordered flex-1 text-center" 
										title="Article Link"
										value={shareUrl}
										readonly
										id="post-url-input"
									/>
								</div>
							</div>
							<ul class="social flex justify-center gap-4 list-none p-0">
								<li>
									<a 
										target="_blank" 
										rel="noopener noreferrer"
										href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}`}
										class="text-2xl hover:opacity-80 transition-opacity text-primary"
										aria-label="Share on Facebook"
									>
										<i class="fa-brands fa-facebook"></i>
									</a>
								</li>
								<li>
									<a 
										target="_blank" 
										rel="noopener noreferrer"
										href={`https://x.com/intent/tweet?url=${encodeURIComponent(shareUrl)}`}
										class="text-2xl hover:opacity-80 transition-opacity text-primary"
										aria-label="Share on Twitter"
									>
										<i class="fa-brands fa-twitter"></i>
									</a>
								</li>
								<li>
									<a 
										target="_blank" 
										rel="noopener noreferrer"
										href={`https://t.me/share/url?url=${encodeURIComponent(shareUrl)}`}
										class="text-2xl hover:opacity-80 transition-opacity text-primary"
										aria-label="Share on Telegram"
									>
										<i class="fa-brands fa-telegram"></i>
									</a>
								</li>
								<li>
									<a 
										target="_blank" 
										rel="noopener noreferrer"
										href={`whatsapp://send?text=${encodeURIComponent(shareUrl)}`}
										class="text-2xl hover:opacity-80 transition-opacity text-primary"
										aria-label="Share on WhatsApp"
									>
										<i class="fa-brands fa-whatsapp"></i>
									</a>
								</li>
							</ul>
						</div>
					</div>
				</div>
			</article>
		</main>
		<Footer />
		<SettingsModal />
		<script>
			// Copy URL to clipboard functionality
			const urlInput = document.getElementById('post-url-input') as HTMLInputElement;
			if (urlInput) {
				urlInput.addEventListener('click', function() {
					this.select();
					document.execCommand('copy');
					// Optional: Show a toast notification
					const originalValue = this.value;
					this.value = 'Copied!';
					setTimeout(() => {
						this.value = originalValue;
					}, 2000);
				});
			}

			// Apply typography settings only to blog post content
			function applyPostTypography() {
				// Default to 18px if no setting exists, otherwise use localStorage value
				const savedFontSize = localStorage.getItem('fontSize');
				const fontSize = savedFontSize ? savedFontSize : '18';
				const lineHeight = localStorage.getItem('lineHeight') || '1.5';
				
				// Find the article element (blog post content)
				const article = document.querySelector('article[data-pagefind-body]');
				if (!article) return;
				
				// Create or update style element for post typography
				let postTypographyStyle = document.getElementById('post-typography-settings');
				if (!postTypographyStyle) {
					postTypographyStyle = document.createElement('style');
					postTypographyStyle.id = 'post-typography-settings';
					document.head.appendChild(postTypographyStyle);
				}
				
				// Apply typography only to article content (not headers, metadata, etc.)
				postTypographyStyle.textContent = `
					.post-content p,
					.post-content li,
					.post-content span,
					.post-content div,
					.post-content h1,
					.post-content h2,
					.post-content h3,
					.post-content h4,
					.post-content h5,
					.post-content h6,
					.post-content blockquote {
						font-size: ${fontSize}px !important;
						line-height: ${lineHeight} !important;
					}
				`;
			}
			
			// Apply typography immediately
			applyPostTypography();
			
			// Re-apply on DOM ready
			if (document.readyState === 'loading') {
				document.addEventListener('DOMContentLoaded', applyPostTypography);
			} else {
				setTimeout(applyPostTypography, 0);
			}
			
			// Listen for typography changes from settings modal
			window.addEventListener('storage', (e) => {
				if (e.key === 'fontSize' || e.key === 'lineHeight') {
					applyPostTypography();
				}
			});
			
			// Also listen for custom event from settings modal
			window.addEventListener('typographyUpdated', applyPostTypography);
		</script>
	</body>
</html>
