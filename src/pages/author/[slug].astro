---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Container from '../../components/Container.astro';
import PostGrid from '../../components/PostGrid.astro';
import Pagination from '../../components/Pagination.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../../consts';

export async function getStaticPaths() {
	const allPosts = await getCollection('blog');
	
	// Get all unique authors
	const authors = new Set<string>();
	allPosts.forEach((post) => {
		if (post.data.author) {
			authors.add(post.data.author);
		}
	});
	
	const pageSize = 9;
	
	// Generate paths for each author (page 1 only)
	const paths: any[] = [];
	for (const author of authors) {
		const authorPosts = allPosts.filter((post) => post.data.author === author);
		const totalPages = Math.ceil(authorPosts.length / pageSize);
		
		// Only generate page 1 for this route
		const start = 0;
		const end = pageSize;
		const pageData = authorPosts.slice(start, end);
		
		paths.push({
			params: { slug: author },
			props: { 
				page: {
					data: pageData,
					currentPage: 1,
					lastPage: totalPages,
					url: {
						current: `/author/${author}/`,
						prev: undefined,
						next: totalPages > 1 ? `/author/${author}/page/2/` : undefined,
						first: `/author/${author}/`,
						last: totalPages > 1 ? `/author/${author}/page/${totalPages}/` : `/author/${author}/`,
					}
				}, 
				author 
			},
		});
	}
	
	return paths;
}

interface Page {
	data: any[];
	currentPage: number;
	lastPage: number;
	url: {
		current: string;
		prev?: string;
		next?: string;
		first?: string;
		last?: string;
	};
}

const { page, author } = Astro.props as { page: Page; author: string };

// Get total post count for this author
const allPosts = await getCollection('blog');
const authorPosts = allPosts.filter((post) => post.data.author === author);
const totalPostCount = authorPosts.length;
---

<BaseLayout title={`${author} - ${SITE_TITLE}`} description={SITE_DESCRIPTION}>
	<Container>
		<section>
			<h1 class="text-2xl md:text-3xl font-bold mb-6 text-center">
				<i class="fas fa-feather-alt mr-2"></i>
				{author} ({totalPostCount})
			</h1>
			<PostGrid posts={page.data} />
			<Pagination 
				currentPage={page.currentPage} 
				totalPages={page.lastPage}
				getPageUrl={(pageNum) => pageNum === 1 ? `/author/${author}/` : `/author/${author}/page/${pageNum}/`}
			/>
		</section>
	</Container>
</BaseLayout>

