---
import { getCollection } from 'astro:content';
import BaseHead from '../../../components/BaseHead.astro';
import Footer from '../../../components/Footer.astro';
import Header from '../../../components/Header.astro';
import PostCard from '../../../components/PostCard.astro';
import ViewControls from '../../../components/ViewControls.astro';
import SettingsModal from '../../../components/SettingsModal.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../../../consts';

export async function getStaticPaths() {
	const allPosts = await getCollection('blog');
	
	// Get all unique authors
	const authors = new Set<string>();
	allPosts.forEach((post) => {
		if (post.data.author) {
			authors.add(post.data.author);
		}
	});
	
	const pageSize = 9;
	
	// Generate paths for each author (pages 2+)
	const paths: any[] = [];
	for (const author of authors) {
		const authorPosts = allPosts.filter((post) => post.data.author === author);
		const totalPages = Math.ceil(authorPosts.length / pageSize);
		
		// Generate paginated pages for this author (starting from page 2)
		for (let page = 2; page <= totalPages; page++) {
			const start = (page - 1) * pageSize;
			const end = start + pageSize;
			const pageData = authorPosts.slice(start, end);
			
			paths.push({
				params: { slug: author, page: page.toString() },
				props: { 
					page: {
						data: pageData,
						currentPage: page,
						lastPage: totalPages,
						url: {
							current: `/author/${author}/${page}/`,
							prev: page === 2 ? `/author/${author}/` : `/author/${author}/${page - 1}/`,
							next: page < totalPages ? `/author/${author}/${page + 1}/` : undefined,
							first: `/author/${author}/`,
							last: totalPages > 1 ? `/author/${author}/${totalPages}/` : `/author/${author}/`,
						}
					}, 
					author 
				},
			});
		}
	}
	
	return paths;
}

interface Page {
	data: any[];
	currentPage: number;
	lastPage: number;
	url: {
		current: string;
		prev?: string;
		next?: string;
		first?: string;
		last?: string;
	};
}

const { page, author } = Astro.props as { page: Page; author: string };

// Generate pagination numbers with ellipsis
function getPaginationNumbers(current: number, total: number): (number | 'ellipsis')[] {
	const pages: (number | 'ellipsis')[] = [];
	
	if (total <= 5) {
		for (let i = 1; i <= total; i++) {
			pages.push(i);
		}
	} else {
		pages.push(1);
		
		if (current <= 3) {
			for (let i = 2; i <= Math.min(current + 1, total - 1); i++) {
				pages.push(i);
			}
			if (current + 1 < total - 1) {
				pages.push('ellipsis');
			}
			pages.push(total);
		} else if (current >= total - 2) {
			pages.push('ellipsis');
			for (let i = Math.max(2, current - 1); i <= total; i++) {
				pages.push(i);
			}
		} else {
			pages.push('ellipsis');
			pages.push(current - 1);
			pages.push(current);
			pages.push(current + 1);
			pages.push('ellipsis');
			pages.push(total);
		}
	}
	
	return pages;
}

const paginationNumbers = getPaginationNumbers(page.currentPage, page.lastPage);
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={`${author} - ${SITE_TITLE}`} description={SITE_DESCRIPTION} />
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" />
	</head>
	<body>
		<Header />
		<main class="block w-[960px] max-w-[calc(100%-30px)] mx-auto py-6 md:py-12 px-2 md:px-[15px]">
			<section>
				<h1 class="text-2xl md:text-3xl font-bold mb-6 text-center">
					<i class="fas fa-feather-alt mr-2"></i>
					{author}
				</h1>
				<ul class="grid-view flex flex-wrap gap-x-8 gap-y-[30px] md:gap-y-8 list-none m-0 p-0">
					<style is:global>
						ul.list-view .grid-view-card { display: none !important; }
						ul.list-view .list-view-card { display: flex !important; }
						ul.list-view li { width: 100%; }
						ul.grid-view li { width: calc(33.333% - 1.334rem); }
						@media (min-width: 721px) and (max-width: 1024px) {
							ul.grid-view li { width: calc(50% - 1rem); }
						}
						@media (max-width: 720px) {
							ul.grid-view li { width: 100%; }
							ul { gap: 0.5rem; }
						}
					</style>
					{
						page.data.map((post: any) => (
							<li>
								<PostCard 
									post={post}
									title={true}
									thumbnail={true}
									author={true}
									excerpt={true}
									date={true}
									readingTime={true}
								/>
							</li>
						))
					}
				</ul>
				{page.lastPage > 1 && (
					<nav class="flex justify-center items-center gap-2 my-8 p-4">
						{
							paginationNumbers.map((pageNum) => {
								if (pageNum === 'ellipsis') {
									return <span class="px-2 py-1.5 text-base-content/60 text-sm">...</span>;
								}
								const isCurrent = pageNum === page.currentPage;
								if (isCurrent) {
									return (
										<span class="px-3 py-1.5 border border-primary rounded-md font-bold bg-primary text-primary-content pointer-events-none cursor-default text-sm">
											{pageNum}
										</span>
									);
								}
								const href = pageNum === 1 ? `/author/${author}/` : `/author/${author}/${pageNum}/`;
								return (
									<a href={href} class="px-3 py-1.5 border border-base-content/20 rounded-md no-underline text-base-content bg-base-100 transition-all text-sm hover:bg-primary hover:text-primary-content hover:border-primary">
										{pageNum}
									</a>
								);
							})
						}
					</nav>
				)}
			</section>
		</main>
		<Footer />
		<SettingsModal />
	</body>
</html>

