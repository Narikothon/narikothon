---
import { getCollection } from 'astro:content';
import BaseLayout from '../../../../layouts/BaseLayout.astro';
import Container from '../../../../components/Container.astro';
import PostGrid from '../../../../components/PostGrid.astro';
import Pagination from '../../../../components/Pagination.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../../../../consts';
import { authorSlug, getAuthorName } from '../../../../lib/slug';

export async function getStaticPaths() {
	const allPosts = await getCollection('blog');
	
	// Get all unique authors
	const authors = new Set<string>();
	allPosts.forEach((post) => {
		if (post.data.author) {
			authors.add(post.data.author);
		}
	});
	
	const pageSize = 9;
	
	// Generate paths for each author (pages 2+)
	const paths: any[] = [];
	for (const author of authors) {
		const authorPosts = allPosts
			.filter((post) => post.data.author === author)
			.sort((a, b) => (b.data.pubDate?.valueOf() || 0) - (a.data.pubDate?.valueOf() || 0));
		const totalPages = Math.ceil(authorPosts.length / pageSize);
		
		// Generate paginated pages for this author (starting from page 2)
		for (let page = 2; page <= totalPages; page++) {
			const start = (page - 1) * pageSize;
			const end = start + pageSize;
			const pageData = authorPosts.slice(start, end);
			
			const slug = authorSlug(author);
			paths.push({
				params: { slug, page: page.toString() },
				props: { 
					page: {
						data: pageData,
						currentPage: page,
						lastPage: totalPages,
						url: {
							current: `/author/${slug}/page/${page}/`,
							prev: page === 2 ? `/author/${slug}/` : `/author/${slug}/page/${page - 1}/`,
							next: page < totalPages ? `/author/${slug}/page/${page + 1}/` : undefined,
							first: `/author/${slug}/`,
							last: totalPages > 1 ? `/author/${slug}/page/${totalPages}/` : `/author/${slug}/`,
						}
					}, 
					author 
				},
			});
		}
	}
	
	return paths;
}

interface Page {
	data: any[];
	currentPage: number;
	lastPage: number;
	url: {
		current: string;
		prev?: string;
		next?: string;
		first?: string;
		last?: string;
	};
}

const { page, author } = Astro.props as { page: Page; author: string };
// Get the slug from params and find the author name
const slugParam = Astro.params.slug || '';
const authorName = getAuthorName(slugParam) || author;
const slug = authorSlug(authorName);

// Get total post count for this author
const allPosts = await getCollection('blog');
const authorPosts = allPosts
	.filter((post) => post.data.author === authorName)
	.sort((a, b) => (b.data.pubDate?.valueOf() || 0) - (a.data.pubDate?.valueOf() || 0));
const totalPostCount = authorPosts.length;
---

<BaseLayout title={`${author} - ${SITE_TITLE}`} description={SITE_DESCRIPTION}>
	<Container>
		<section>
			<h1 class="text-2xl md:text-3xl font-bold mb-6 text-center">
				<i class="fas fa-feather-alt mr-2"></i>
				{authorName} ({totalPostCount})
			</h1>
			<PostGrid posts={page.data} />
			<Pagination 
				currentPage={page.currentPage} 
				totalPages={page.lastPage}
				getPageUrl={(pageNum) => pageNum === 1 ? `/author/${slug}/` : `/author/${slug}/page/${pageNum}/`}
			/>
		</section>
	</Container>
</BaseLayout>

