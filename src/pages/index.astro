---
import { getCollection } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import Header from '../components/Header.astro';
import PostCard from '../components/PostCard.astro';
import SettingsModal from '../components/SettingsModal.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../consts';

const allPosts = (await getCollection('blog')).sort(
	(a, b) => (b.data.pubDate?.valueOf() || 0) - (a.data.pubDate?.valueOf() || 0),
);

const pageSize = 9;
const currentPage = 1;
const totalPages = Math.ceil(allPosts.length / pageSize);
const startIndex = (currentPage - 1) * pageSize;
const endIndex = startIndex + pageSize;
const posts = allPosts.slice(startIndex, endIndex);

// Generate pagination numbers with ellipsis
function getPaginationNumbers(current: number, total: number): (number | 'ellipsis')[] {
	const pages: (number | 'ellipsis')[] = [];
	
	if (total <= 5) {
		// If 5 or fewer pages, show all
		for (let i = 1; i <= total; i++) {
			pages.push(i);
		}
	} else {
		// Always show first page
		pages.push(1);
		
		if (current <= 3) {
			// Near the beginning: 1, 2, 3, 4, ..., last
			// Show consecutive pages from 1 up to current + 1
			for (let i = 2; i <= Math.min(current + 1, total - 1); i++) {
				pages.push(i);
			}
			if (current + 1 < total - 1) {
				pages.push('ellipsis');
			}
			pages.push(total);
		} else if (current >= total - 2) {
			// Near the end: 1, ..., last-3, last-2, last-1, last
			pages.push('ellipsis');
			for (let i = Math.max(2, current - 1); i <= total; i++) {
				pages.push(i);
			}
		} else {
			// In the middle: 1, ..., prev, current, next, ..., last
			pages.push('ellipsis');
			pages.push(current - 1);
			pages.push(current);
			pages.push(current + 1);
			pages.push('ellipsis');
			pages.push(total);
		}
	}
	
	return pages;
}

const paginationNumbers = getPaginationNumbers(currentPage, totalPages);
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" />
	</head>
	<body>
		<Header />
		<main class="w-[960px] max-w-[calc(100%-30px)] mx-auto py-6 md:py-12 px-2 md:px-[15px]">
			<section>
				<ul class="grid-view flex flex-wrap gap-x-8 gap-y-[30px] md:gap-y-8 list-none m-0 p-0">
					{
						posts.map((post: any) => (
							<li>
								<PostCard 
									post={post}
									title={true}
									thumbnail={true}
									author={true}
									excerpt={true}
									date={true}
									readingTime={true}
								/>
							</li>
						))
					}
				</ul>
				{totalPages > 1 && (
					<nav class="flex justify-center items-center gap-2 my-8 p-4">
						{
							paginationNumbers.map((pageNum) => {
								if (pageNum === 'ellipsis') {
									return <span class="px-2 py-1.5 text-base-content/60 text-sm">...</span>;
								}
								const isCurrent = pageNum === currentPage;
								if (isCurrent) {
									return (
										<span class="px-3 py-1.5 border border-primary rounded-md font-bold bg-primary text-primary-content pointer-events-none cursor-default text-sm">
											{pageNum}
										</span>
									);
								}
								const href = pageNum === 1 ? '/' : `/${pageNum}`;
								return (
									<a href={href} class="px-3 py-1.5 border border-base-content/20 rounded-md no-underline text-base-content bg-base-100 transition-all text-sm hover:bg-primary hover:text-primary-content hover:border-primary">
										{pageNum}
									</a>
								);
							})
						}
					</nav>
				)}
			</section>
		</main>
		<Footer />
		<SettingsModal />
	</body>
</html>
