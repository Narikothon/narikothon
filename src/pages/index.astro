---
import { getCollection } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import Header from '../components/Header.astro';
import PostCard from '../components/PostCard.astro';
import ViewControls from '../components/ViewControls.astro';
import SettingsModal from '../components/SettingsModal.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../consts';

const allPosts = (await getCollection('blog')).sort(
	(a, b) => (b.data.pubDate?.valueOf() || 0) - (a.data.pubDate?.valueOf() || 0),
);

const pageSize = 9;
const currentPage = 1;
const totalPages = Math.ceil(allPosts.length / pageSize);
const startIndex = (currentPage - 1) * pageSize;
const endIndex = startIndex + pageSize;
const posts = allPosts.slice(startIndex, endIndex);

// Generate pagination numbers with ellipsis
function getPaginationNumbers(current: number, total: number): (number | 'ellipsis')[] {
	const pages: (number | 'ellipsis')[] = [];
	
	if (total <= 5) {
		// If 5 or fewer pages, show all
		for (let i = 1; i <= total; i++) {
			pages.push(i);
		}
	} else {
		// Always show first page
		pages.push(1);
		
		if (current <= 3) {
			// Near the beginning: 1, 2, 3, 4, ..., last
			// Show consecutive pages from 1 up to current + 1
			for (let i = 2; i <= Math.min(current + 1, total - 1); i++) {
				pages.push(i);
			}
			if (current + 1 < total - 1) {
				pages.push('ellipsis');
			}
			pages.push(total);
		} else if (current >= total - 2) {
			// Near the end: 1, ..., last-3, last-2, last-1, last
			pages.push('ellipsis');
			for (let i = Math.max(2, current - 1); i <= total; i++) {
				pages.push(i);
			}
		} else {
			// In the middle: 1, ..., prev, current, next, ..., last
			pages.push('ellipsis');
			pages.push(current - 1);
			pages.push(current);
			pages.push(current + 1);
			pages.push('ellipsis');
			pages.push(total);
		}
	}
	
	return pages;
}

const paginationNumbers = getPaginationNumbers(currentPage, totalPages);
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" />
		<style>
			main {
				width: 960px;
				max-width: calc(100% - 2em);
				margin: auto;
				padding: 3em 1em;
			}
			.view-controls {
				display: flex;
				justify-content: flex-start;
				align-items: center;
				gap: 0.5rem;
				margin-bottom: 2rem;
				padding: 1rem 0;
			}
			.view-controls .btn2 {
				padding: 0.5rem 0.75rem;
				border: 1px solid rgb(var(--gray));
				border-radius: 4px;
				background-color: white;
				color: rgb(var(--black));
				cursor: pointer;
				transition: 0.2s ease;
				display: inline-flex;
				align-items: center;
				justify-content: center;
			}
			.view-controls .btn2:hover {
				background-color: rgb(var(--gray-light));
				border-color: rgb(var(--accent));
			}
			.view-controls .btn2.active {
				background-color: var(--accent);
				color: white;
				border-color: var(--accent);
			}
			.view-controls .btn2 i {
				font-size: 1.25em;
			}
			ul {
				display: flex;
				flex-wrap: wrap;
				gap: 2rem;
				list-style-type: none;
				margin: 0;
				padding: 0;
			}
			/* Grid view */
			ul.grid-view li {
				width: calc(33.333% - 1.334rem);
			}
			ul li {
				width: calc(33.333% - 1.334rem);
			}
			/* List view */
			ul.list-view {
				flex-direction: column;
			}
			ul.list-view li {
				width: 100%;
			}
			ul li * {
				text-decoration: none;
				transition: 0.2s ease;
			}
			ul li img {
				margin-bottom: 0.5rem;
				border-radius: 12px;
			}
			ul li a {
				display: block;
			}
			.title {
				margin: 0;
				color: rgb(var(--black));
				line-height: 1;
			}
			.date {
				margin: 0;
				color: rgb(var(--gray));
			}
			ul li a:hover h4,
			ul li a:hover .date {
				color: rgb(var(--accent));
			}
			ul a:hover img {
				box-shadow: var(--box-shadow);
			}
			.pagination {
				display: flex;
				justify-content: center;
				align-items: center;
				gap: 1rem;
				margin: 2rem 0;
				padding: 1rem;
			}
			.pagination a {
				padding: 0.5rem 1rem;
				border: 1px solid rgb(var(--gray));
				border-radius: 4px;
				text-decoration: none;
				color: rgb(var(--black));
				background-color: white;
				transition: 0.2s ease;
			}
			.pagination a:hover {
				background-color: var(--accent);
				color: white !important;
				border-color: var(--accent);
			}
			.pagination .current {
				padding: 0.5rem 1rem;
				border: 1px solid var(--accent);
				border-radius: 4px;
				font-weight: bold;
				background-color: var(--accent);
				color: white !important;
				pointer-events: none;
				cursor: default;
			}
			.pagination .current:hover {
				background-color: var(--accent);
				color: white !important;
			}
			.pagination .disabled {
				opacity: 0.5;
				pointer-events: none;
			}
			.pagination .ellipsis {
				padding: 0.5rem 0.5rem;
				color: rgb(var(--gray));
			}
			/* Tablet: 2 columns */
			@media (max-width: 1024px) and (min-width: 721px) {
				ul.grid-view li,
				ul li {
					width: calc(50% - 1rem);
				}
			}
			/* Mobile: 1 column */
			@media (max-width: 720px) {
				main {
					padding: 1em 0.5em;
				}
				ul {
					gap: 0.5em;
				}
				ul.grid-view li,
				ul li {
					width: 100%;
				}
				img {
					display: block;
					margin-left: auto;
					margin-right: auto;
				}
				p {
					text-align: justify;
				}
			}
		</style>
	</head>
	<body>
		<Header />
		<main>
			<section>
				<ViewControls />
				<ul>
					{
						posts.map((post: any) => (
							<li>
								<PostCard 
									post={post}
									title={true}
									thumbnail={true}
									author={true}
									excerpt={true}
									date={true}
									readingTime={true}
								/>
							</li>
						))
					}
				</ul>
				{totalPages > 1 && (
					<nav class="pagination">
						{
							paginationNumbers.map((pageNum) => {
								if (pageNum === 'ellipsis') {
									return <span class="ellipsis">...</span>;
								}
								const isCurrent = pageNum === currentPage;
								if (isCurrent) {
									return (
										<span class="current">
											{pageNum}
										</span>
									);
								}
								const href = pageNum === 1 ? '/' : `/${pageNum}`;
								return (
									<a href={href}>
										{pageNum}
									</a>
								);
							})
						}
					</nav>
				)}
			</section>
		</main>
		<Footer />
		<SettingsModal />
	</body>
</html>
