---
import { getCollection } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import Container from '../../../components/Container.astro';
import PostGrid from '../../../components/PostGrid.astro';
import Pagination from '../../../components/Pagination.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../../../consts';

export async function getStaticPaths() {
	const allPosts = await getCollection('blog');
	
	// Get all unique categories
	const categories = new Set<string>();
	allPosts.forEach((post) => {
		if (post.data.categories && post.data.categories.length > 0) {
			post.data.categories.forEach((category) => {
				categories.add(category);
			});
		}
	});
	
	const pageSize = 9;
	
	// Generate paths for each category (pages 2+)
	const paths: any[] = [];
	for (const category of categories) {
		const categoryPosts = allPosts.filter((post) => 
			post.data.categories && post.data.categories.includes(category)
		);
		const totalPages = Math.ceil(categoryPosts.length / pageSize);
		const categorySlug = encodeURIComponent(category);
		
		// Generate paginated pages for this category (starting from page 2)
		for (let page = 2; page <= totalPages; page++) {
			const start = (page - 1) * pageSize;
			const end = start + pageSize;
			const pageData = categoryPosts.slice(start, end);
			
			paths.push({
				params: { slug: categorySlug, page: page.toString() },
				props: { 
					page: {
						data: pageData,
						currentPage: page,
						lastPage: totalPages,
						url: {
							current: `/category/${categorySlug}/${page}/`,
							prev: page === 2 ? `/category/${categorySlug}/` : `/category/${categorySlug}/${page - 1}/`,
							next: page < totalPages ? `/category/${categorySlug}/${page + 1}/` : undefined,
							first: `/category/${categorySlug}/`,
							last: totalPages > 1 ? `/category/${categorySlug}/${totalPages}/` : `/category/${categorySlug}/`,
						}
					}, 
					category 
				},
			});
		}
	}
	
	return paths;
}

interface Page {
	data: any[];
	currentPage: number;
	lastPage: number;
	url: {
		current: string;
		prev?: string;
		next?: string;
		first?: string;
		last?: string;
	};
}

const { page, category } = Astro.props as { page: Page; category: string };
const categorySlug = encodeURIComponent(category);

// Get total post count for this category
const allPosts = await getCollection('blog');
const categoryPosts = allPosts.filter((post) => 
	post.data.categories && post.data.categories.includes(category)
);
const totalPostCount = categoryPosts.length;
---

<BaseLayout title={`${category} - ${SITE_TITLE}`} description={SITE_DESCRIPTION}>
	<Container>
		<section>
			<h1 class="text-2xl md:text-3xl font-bold mb-6 text-center">
				<i class="fa-solid fa-hashtag mr-2"></i>
				{category} ({totalPostCount})
			</h1>
			<PostGrid posts={page.data} />
			<Pagination 
				currentPage={page.currentPage} 
				totalPages={page.lastPage}
				getPageUrl={(pageNum) => pageNum === 1 ? `/category/${categorySlug}/` : `/category/${categorySlug}/${pageNum}/`}
			/>
		</section>
	</Container>
</BaseLayout>

